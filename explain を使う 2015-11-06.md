# explain を使う 2015/11/06

以下の記事を参考にクエリプランを取得した．

http://virtuoso.openlinksw.com/dataspace/doc/dav/wiki/Main/VirtTipsAndTricksAanalyzingSPARQLQuery

## 使用した SPARQL クエリ

ProductType ビュークエリ

```
select ?pt ?ptlbl where {
?pt <http://www.w3.org/1999/02/22-rdf-syntax-ns#type>
<http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/vocabulary/ProductType> .
?pt <http://www.w3.org/2000/01/rdf-schema#label> ?ptlbl . };
```

データセット (Example RDF Instance)

```
bsbm-inst:ProductType011432
 rdf:type bsbm:ProductType ;
 rdfs:label "Digital Camera" ;
 rdfs:comment "A camera that records pictures electronically rather than on film." ;
 rdfs:subClassOf bsbm-inst:ProductType011000
 dc:publisher bsbm-inst:StandardizationInstitution01 ;
 dc:date "2008-02-13"^^xsd:date .
```

クエリ結果

```
pt	ptlbl
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType1	"Thing"
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType10	"sheeny"
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType100	"meaningfulness refulgence"
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType101	"sharpies amazing"
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType102	"factotum"
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType103	"decompensates antidepressant undisputed"
...
(329 rows)
```


(NOTE:PREFIX や　＊等を使うと受け付けない)

## SPARQL クエリを，対応する SQL クエリに変換

```
SQL> SET SPARQL_TRANSLATE ON;
SQL> select ?pt ?ptlbl where {
?pt <http://www.w3.org/1999/02/22-rdf-syntax-ns#type> <http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/vocabulary/ProductType> .
?pt <http://www.w3.org/2000/01/rdf-schema#label> ?ptlbl . };

SPARQL_TO_SQL_TEXT
LONG VARCHAR
_______________________________________________________________________________

SELECT __id2in ( "s_2_4_t0"."S") AS "pt",
  __ro2sq ( "s_2_4_t1"."O") AS "ptlbl"
FROM DB.DBA.RDF_QUAD AS "s_2_4_t0"
  INNER JOIN DB.DBA.RDF_QUAD AS "s_2_4_t1"
  ON (
    "s_2_4_t0"."S" = "s_2_4_t1"."S")
WHERE
  "s_2_4_t0"."P" = __i2idn ( __bft( 'http://www.w3.org/1999/02/22-rdf-syntax-ns#type' , 1))
  AND
  "s_2_4_t0"."O" = __i2idn ( __bft( 'http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/vocabulary/ProductType' , 1))
  AND
  "s_2_4_t1"."P" = __i2idn ( __bft( 'http://www.w3.org/2000/01/rdf-schema#label' , 1))
OPTION (QUIETCAST)

1 Rows. -- 4 msec.
SQL> SET SPARQL_TRANSLATE OFF;
```

## SQL クエリから compilation plan を生成

```
SQL> SET EXPLAIN ON;
SQL> SELECT __id2in ( "s_2_4_t0"."S") AS "pt",
  __ro2sq ( "s_2_4_t1"."O") AS "ptlbl"
FROM DB.DBA.RDF_QUAD AS "s_2_4_t0"
  INNER JOIN DB.DBA.RDF_QUAD AS "s_2_4_t1"
  ON (
    "s_2_4_t0"."S" = "s_2_4_t1"."S")
WHERE
  "s_2_4_t0"."P" = __i2idn ( __bft( 'http://www.w3.org/1999/02/22-rdf-syntax-ns#type' , 1))
  AND
  "s_2_4_t0"."O" = __i2idn ( __bft( 'http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/vocabulary/ProductType' , 1))
  AND
  "s_2_4_t1"."P" = __i2idn ( __bft( 'http://www.w3.org/2000/01/rdf-schema#label' , 1)) ;
REPORT
VARCHAR
_______________________________________________________________________________

{
  clear: (<V $43 set_ctr in>)
s# 46 44 cluster outer seq start, set no <V $43 set_ctr in>
save ctx:()
  clear: (<V $28 s_2_4_t0.S rn>)
  clear on continue: (<V $28 s_2_4_t0.S rn>)
s# 51 27 from DB.DBA.RDF_QUAD by RDF_QUAD_POGS    3.3e+02 rows
Key RDF_QUAD_POGS  ASC  (<V $28 s_2_4_t0.S rn>)
 P =  ##type  ,  O =  #/ProductType

  clear: (<V $31 s_2_4_t1.O an>, <V $35 ptlbl a>, <V $33 pt a>)
  clear on continue: (<V $31 s_2_4_t1.O an>, <V $35 ptlbl a>, <V $33 pt a>)$28 ()
s# 57 30 from DB.DBA.RDF_QUAD by RDF_QUAD          1 rows
Key RDF_QUAD  ASC  (<V $31 s_2_4_t1.O an>)
 inlined  P =  ##label  ,  S = <V $28 s_2_4_t0.S rn>


After code:
      0: <V $33 pt a> := Call __id2in (<r $28 s_2_4_t0.S via  S57>)
      5: <V $35 ptlbl a> := Call __ro2sq (<V $31 s_2_4_t1.O an>)
      10: BReturn 0
$33 () $35 () $43 (30 27 44 )
s# 63 37 Select (<V $33 pt a>, <V $35 ptlbl a>)
  set no: <r $43 set_ctr via  S57 S51>
}

25 Rows. -- 3 msec.
SQL> SET EXPLAIN OFF;
```

## SQL プランから compilation および excecute plan を生成

```
SQL> SET PROFILE ON;
SQL> SELECT __id2in ( "s_2_4_t0"."S") AS "pt",
  __ro2sq ( "s_2_4_t1"."O") AS "ptlbl"
FROM DB.DBA.RDF_QUAD AS "s_2_4_t0"
  INNER JOIN DB.DBA.RDF_QUAD AS "s_2_4_t1"
  ON (
    "s_2_4_t0"."S" = "s_2_4_t1"."S")
WHERE
  "s_2_4_t0"."P" = __i2idn ( __bft( 'http://www.w3.org/1999/02/22-rdf-syntax-ns#type' , 1))
  AND
  "s_2_4_t0"."O" = __i2idn ( __bft( 'http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/vocabulary/ProductType' , 1))
  AND
  "s_2_4_t1"."P" = __i2idn ( __bft( 'http://www.w3.org/2000/01/rdf-schema#label' , 1)) ;
REPORT
VARCHAR
_______________________________________________________________________________

{
  clear: (<V $43 set_ctr in>)
s# 46 44 cluster outer seq start, set no <V $43 set_ctr in>
save ctx:()
  clear: (<V $28 s_2_4_t0.S rn>)
  clear on continue: (<V $28 s_2_4_t0.S rn>)
s# 51 27 from DB.DBA.RDF_QUAD by RDF_QUAD_POGS    3.3e+02 rows
Key RDF_QUAD_POGS  ASC  (<V $28 s_2_4_t0.S rn>)
 P =  ##type  ,  O =  #/ProductType

  clear: (<V $31 s_2_4_t1.O an>, <V $35 ptlbl a>, <V $33 pt a>)
  clear on continue: (<V $31 s_2_4_t1.O an>, <V $35 ptlbl a>, <V $33 pt a>)$28 ()
s# 57 30 from DB.DBA.RDF_QUAD by RDF_QUAD          1 rows
Key RDF_QUAD  ASC  (<V $31 s_2_4_t1.O an>)
 inlined  P =  ##label  ,  S = <V $28 s_2_4_t0.S rn>


After code:
      0: <V $33 pt a> := Call __id2in (<r $28 s_2_4_t0.S via  S57>)
      5: <V $35 ptlbl a> := Call __ro2sq (<V $31 s_2_4_t1.O an>)
      10: BReturn 0
$33 () $35 () $43 (30 27 44 )
s# 63 37 Select (<V $33 pt a>, <V $35 ptlbl a>)
  set no: <r $43 set_ctr via  S57 S51>
}

25 Rows. -- 1 msec.
SQL> SET PROFILE OFF;
```

## 更に詳細な query profile with cardinarity can be obtained by executing the following following sequence

```

SQL> __dbf_set('enable_qr_comment', 1);
SQL> __dbf_set('dbf_explain_level', 3);
SQL> SET PROFILE ON;
SQL> SET BLOBS ON;
SQL> result
LONG VARCHAR
_______________________________________________________________________________

http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType1   Thing
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType10  sheeny
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType100 meaningfulness refulgence
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType101 sharpies amazing
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType102 factotum
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType103 decompensates antidepressant undisputed
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType104 girthed airmails kanas
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType105 tetherball plena sieurs
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType106 obviating griefs
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType107 devolutive priceless picadors
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType108 senselessly bitterly
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType109 perceptively patricides
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType11  playacted
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType110 luridly
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType111 innocenter paperboys
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType112 markups manuevered
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType113 munches hardener
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType114 alpinism
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType115 situational
http://www4.wiwiss.fu-berlin.de/bizer/bsbm/v01/instances/ProductType116 ivied

{
time     0.039% fanout         1 input         1 rows
  clear: (<V $43 set_ctr in>)
s# 46 44 cluster outer seq start, set no <V $43 set_ctr in>
save ctx:()
time      0.62% fanout       329 input         1 rows
  clear: (<V $28 s_2_4_t0.S rn>)
  clear on continue: (<V $28 s_2_4_t0.S rn>)
s# 55 27 from DB.DBA.RDF_QUAD by RDF_QUAD_POGS    3.3e+02 rows
Key RDF_QUAD_POGS  ASC  (<V $28 s_2_4_t0.S rn>)
 P =  ##type  ,  O =  #/ProductType

time        99% fanout         1 input       329 rows
  clear: (<V $31 s_2_4_t1.O an>, <V $35 ptlbl a>, <V $33 pt a>)
  clear on continue: (<V $31 s_2_4_t1.O an>, <V $35 ptlbl a>, <V $33 pt a>)$28 ()
s# 65 30 from DB.DBA.RDF_QUAD by RDF_QUAD          1 rows
Key RDF_QUAD  ASC  (<V $31 s_2_4_t1.O an>)
 inlined  P =  ##label  ,  S = <V $28 s_2_4_t0.S rn>


After code:
      0: <V $33 pt a> := Call __id2in (<r $28 s_2_4_t0.S via  S65>)
      5: <V $35 ptlbl a> := Call __ro2sq (<V $31 s_2_4_t1.O an>)
      10: BReturn 0
time     0.013% fanout         0 input       329 rows
$33 () $35 () $43 (30 27 44 )
s# 75 37 Select (<V $33 pt a>, <V $35 ptlbl a>)
  set no: <r $43 set_ctr via  S65 S55>
}
Warning: You might have a Cartesian product.



 4 msec 91% cpu,       658 rnd       328 seq   49.4689% same seg   33.8392% same pg
Compilation: 1 msec 0 reads         0% read 0 messages         0% clw

4 Rows. -- 17 msec.
SQL> SET PROFILE OFF;
```